<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Code Tool | TranslitMedia</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --border: #334155;
            --input-bg: rgba(0,0,0,0.2);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }

        html, body { 
            background-color: var(--bg-color); 
            color: var(--text-primary); 
            min-height: 100vh; 
            width: 100%;
            overflow-x: hidden;
        }

        nav {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 50;
            width: 100%;
        }
        .nav-left { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        .back-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-secondary);
            padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;
            display: flex; align-items: center; gap: 0.4rem; white-space: nowrap;
        }
        .brand { 
            font-weight: 700; font-size: 1rem; color: var(--text-primary); 
            display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; 
            overflow: hidden; text-overflow: ellipsis;
        }
        .brand svg { width: 20px; height: 20px; stroke: var(--accent); flex-shrink: 0; }
        .nav-spacer { width: 70px; flex-shrink: 0; }

        main { 
            flex: 1; 
            max-width: 1200px; 
            margin: 0 auto; 
            width: 100%; 
            padding: 1rem; 
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .tabs { display: flex; background-color: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.25rem; gap: 0.25rem; margin-bottom: 0.5rem; }
        .tab-btn {
            flex: 1; padding: 0.7rem; background: transparent; border: none; color: var(--text-secondary);
            border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s;
        }
        .tab-btn.active { background-color: var(--accent); color: white; }

        .section { display: none; width: 100%; }
        .section.active { display: block; }

        .generator-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1.5rem;
            width: 100%;
        }

        .panel { 
            background-color: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 1.25rem; 
            overflow: hidden; 
            height: fit-content;
            width: 100%;
        }

        .type-scroll {
            display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; margin-bottom: 1rem;
            scrollbar-width: thin; scrollbar-color: var(--border) transparent;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
        }
        .type-btn {
            background: var(--input-bg); border: 1px solid var(--border); color: var(--text-secondary);
            padding: 0.4rem 0.8rem; border-radius: 20px; cursor: pointer; font-size: 0.8rem; white-space: nowrap;
            flex-shrink: 0; transition: all 0.2s;
        }
        .type-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(99, 102, 241, 0.1); }

        .form-group { margin-bottom: 0.8rem; width: 100%; }
        label { display: block; color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.05em; }
        
        input, select, textarea {
            width: 100%; background-color: var(--input-bg); border: 1px solid var(--border); color: var(--text-primary);
            padding: 0.6rem; border-radius: 6px; outline: none; font-size: 0.9rem; transition: border-color 0.2s;
            max-width: 100%;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); }

        .accordion-header {
            font-size: 0.85rem; font-weight: 700; color: var(--text-secondary);
            padding: 0.75rem 0; border-top: 1px solid var(--border); margin-top: 1rem;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .accordion-content { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }

        .color-pick { display: flex; align-items: center; gap: 0.5rem; background: var(--input-bg); padding: 0.4rem; border-radius: 6px; border: 1px solid var(--border); width: 100%; }
        .color-pick input[type="color"] { width: 24px; height: 24px; padding: 0; border: none; background: none; cursor: pointer; border-radius: 4px; flex-shrink: 0; }
        .color-pick span { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* PREVIEW CONTAINER - RESPONSIVE FIX */
        .preview-container { 
            text-align: center; 
            position: sticky; top: 80px; 
            display: flex; flex-direction: column; gap: 1rem; 
            width: 100%;
        }
        
        .qr-wrapper {
            /* Removed padding to let QR fill */
            background: transparent; 
            padding: 0;
            display: flex; 
            align-items: center; 
            justify-content: center;
            width: 100%;
            margin: 0 auto;
            position: relative;
        }
        
        /* Force SVG/Canvas to fit strictly inside */
        .qr-wrapper canvas, .qr-wrapper svg { 
            max-width: 100% !important;
            height: auto !important;
            width: auto !important;
            display: block;
            border-radius: 8px;
            /* Box shadow directly on the QR code canvas/svg */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
        }

        .btn {
            width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn.primary { background-color: var(--accent); color: white; }
        .btn.primary:hover { background-color: var(--accent-hover); transform: translateY(-1px); }
        .btn.secondary { background-color: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border); }

        .logo-upload-btn { position: relative; overflow: hidden; }
        .logo-upload-btn input { position: absolute; top:0; left:0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        /* Scanner */
        #scanner-view { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem; width: 100%; }
        #reader { 
            width: 100%; border-radius: 12px; overflow: hidden; border: 2px solid var(--border); background: black; min-height: 250px; position: relative;
        }
        #reader video { width: 100% !important; height: auto !important; max-width: 100% !important; object-fit: cover; }
        #reader button {
            color: white !important; background: var(--accent) !important; border: none !important;
            padding: 0.5rem 1rem !important; border-radius: 6px !important; margin-top: 10px !important; cursor: pointer;
        }
        #scan-result { display: none; background: var(--card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--border); word-break: break-all; }
        .result-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }

        @media (max-width: 900px) {
            .generator-grid { grid-template-columns: 1fr; gap: 1.5rem; }
            .preview-container { position: static; margin-top: 1rem; }
            .nav-spacer { display: none; }
            .panel { padding: 1rem; }
            /* On mobile, limit width for aesthetics but allow shrink */
            .qr-wrapper { max-width: 300px; }
        }
    </style>
</head>
<body>

    <nav>
        <div class="nav-left">
            <button class="back-btn" onclick="history.back()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                Back
            </button>
        </div>
        <div class="brand">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
            QR Tool
        </div>
        <div class="nav-spacer"></div>
    </nav>

    <main>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('creator')">Creator</button>
            <button class="tab-btn" onclick="switchTab('scanner')">Scanner</button>
        </div>

        <!-- CREATOR SECTION -->
        <div id="creator-section" class="section active">
            <div class="generator-grid">
                <!-- Left Column: Controls -->
                <div class="panel">
                    <div class="type-scroll" id="type-list">
                        <!-- Buttons injected via JS -->
                    </div>

                    <div id="dynamic-form">
                        <!-- Inputs injected via JS -->
                    </div>

                    <!-- Styling Options -->
                    <div class="accordion-header">DESIGN & STYLE</div>
                    <div class="accordion-content">
                        <div class="form-group">
                            <label>Pattern</label>
                            <select id="dots-style" onchange="updateQR()">
                                <option value="square">Square</option>
                                <option value="dots">Dots</option>
                                <option value="rounded">Rounded</option>
                                <option value="extra-rounded">Extra Rounded</option>
                                <option value="classy">Classy</option>
                                <option value="classy-rounded">Classy Rnd</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Corners</label>
                            <select id="corners-style" onchange="updateQR()">
                                <option value="square">Square</option>
                                <option value="dot">Dot</option>
                                <option value="extra-rounded">Rounded</option>
                            </select>
                        </div>
                        <div class="color-pick">
                            <input type="color" id="fg-color" value="#000000" oninput="updateQR()">
                            <span>Color</span>
                        </div>
                        <div class="color-pick">
                            <input type="color" id="bg-color" value="#ffffff" oninput="updateQR()">
                            <span>BG</span>
                        </div>
                    </div>

                    <div class="accordion-header">LOGO / IMAGE</div>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="btn secondary logo-upload-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Upload Logo
                            <input type="file" id="logo-file" accept="image/*" onchange="handleLogoUpload()">
                        </button>
                        <button class="btn secondary" style="width:auto" onclick="clearLogo()" title="Remove Logo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                </div>

                <!-- Right Column: Preview -->
                <div class="preview-container">
                    <div class="qr-wrapper" id="qr-container">
                        <!-- Canvas rendered here -->
                    </div>
                    
                    <div style="width:100%; display:grid; grid-template-columns: 1fr 1.5fr; gap:0.5rem;">
                        <div class="form-group" style="margin:0">
                            <select id="dl-ext">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                                <option value="svg">SVG</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0">
                            <select id="dl-size">
                                <option value="300">Small (300px)</option>
                                <option value="1000">Medium (1000px)</option>
                                <option value="2000">High (2000px)</option>
                                <option value="4000">Print (4000px)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn primary" onclick="downloadQR()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Download QR
                    </button>
                </div>
            </div>
        </div>

        <!-- SCANNER SECTION -->
        <div id="scanner-section" class="section">
            <div id="scanner-view">
                <div class="panel">
                    <div id="reader"></div>
                    <div style="margin-top:1rem; text-align:center;">
                        <label class="btn secondary" style="cursor:pointer; display:inline-flex; width:auto;">
                            <input type="file" id="scan-file" accept="image/*" onchange="scanFile()" style="display:none;">
                            Upload Image to Scan
                        </label>
                    </div>
                </div>
                
                <div id="scan-result">
                    <div style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase; margin-bottom:0.5rem;">Detected Content</div>
                    <div id="result-text" style="margin-bottom:1rem; font-family:monospace; color:var(--accent); overflow-wrap: anywhere;"></div>
                    <div class="result-actions">
                        <button class="btn primary" onclick="editScanned()">Edit</button>
                        <button class="btn secondary" onclick="copyResult()">Copy</button>
                        <button id="open-btn" class="btn secondary" onclick="openLink()" disabled>Open</button>
                    </div>
                </div>
            </div>
        </div>

    </main>
    <script>
        // --- CONFIGURATION ---
        const formConfig = {
            text: { label: 'Text/URL', fields: [ {id:'text', label:'Content', type:'textarea', rows:3, placeholder:'https://...'} ] },
            wifi: { label: 'WiFi', fields: [
                {id:'ssid', label:'SSID', type:'text'},
                {id:'enc', label:'Security', type:'select', opts:{'WPA':'WPA/WPA2','SAE':'WPA3','WEP':'WEP','nopass':'Open'}},
                {id:'pass', label:'Password', type:'text'},
                {id:'hidden', label:'Hidden Network', type:'checkbox'}
            ]},
            upi: { label: 'UPI', fields: [
                {id:'pa', label:'UPI ID (VPA)', type:'text', placeholder:'name@bank'},
                {id:'pn', label:'Payee Name', type:'text'},
                {id:'am', label:'Amount', type:'number', step:'0.01'},
                {id:'tn', label:'Note', type:'text'}
            ]},
            vcard: { label: 'Contact', fields: [
                {id:'fn', label:'First Name', type:'text'}, {id:'ln', label:'Last Name', type:'text'},
                {id:'tel', label:'Phone', type:'tel'}, {id:'email', label:'Email', type:'email'},
                {id:'org', label:'Company', type:'text'}
            ]},
            whatsapp: { label: 'WhatsApp', fields: [
                {id:'wa_num', label:'Phone (with country code)', type:'tel', placeholder:'15551234567'},
                {id:'wa_msg', label:'Message', type:'textarea', rows:2}
            ]},
            email: { label: 'Email', fields: [
                {id:'mailto', label:'To', type:'email'}, {id:'sub', label:'Subject', type:'text'},
                {id:'body', label:'Body', type:'textarea', rows:3}
            ]},
            sms: { label: 'SMS', fields: [ {id:'sms_tel', label:'Phone', type:'tel'}, {id:'sms_body', label:'Message', type:'textarea', rows:2} ]},
            event: { label: 'Event', fields: [
                {id:'ev_sum', label:'Title', type:'text'}, {id:'ev_loc', label:'Location', type:'text'},
                {id:'ev_start', label:'Start', type:'datetime-local'}, {id:'ev_end', label:'End', type:'datetime-local'}
            ]},
            geo: { label: 'Location', fields: [
                {id:'lat', label:'Latitude', type:'number', step:'any'}, {id:'lon', label:'Longitude', type:'number', step:'any'}
            ]}
        };

        let currentType = 'text';
        let currentLogo = null;
        let html5Scanner = null;
        let scannedData = '';

        // Initialize QR Styling Library
        let qrCode = new QRCodeStyling({
            width: 300,
            height: 300,
            type: "svg",
            data: "https://translitmedia.com",
            image: "",
            margin: 20, // Increased margin for safety and visual space
            dotsOptions: { color: "#000000", type: "square" },
            backgroundOptions: { color: "#ffffff" },
            imageOptions: { crossOrigin: "anonymous", margin: 10 }
        });

        // --- INIT ---
        window.onload = () => {
            renderTypeButtons();
            renderForm('text');
            qrCode.append(document.getElementById("qr-container"));
        };

        // --- TABS & SCANNER LOGIC ---
        function switchTab(t) {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            
            if(t === 'creator') {
                document.getElementById('creator-section').classList.add('active');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                if(html5Scanner) html5Scanner.clear();
            } else {
                document.getElementById('scanner-section').classList.add('active');
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                startScan();
            }
        }

        function startScan() {
            if(!html5Scanner) {
                // Short delay to ensure DOM is ready
                setTimeout(() => {
                    html5Scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: {width: 250, height: 250} }, false);
                    html5Scanner.render(onScanSuccess, (e)=>{});
                }, 100);
            }
        }

        function onScanSuccess(txt) {
            scannedData = txt;
            document.getElementById('scan-result').style.display = 'block';
            document.getElementById('result-text').innerText = txt;
            
            // Link detection
            try {
                new URL(txt);
                document.getElementById('open-btn').disabled = false;
            } catch(e) {
                document.getElementById('open-btn').disabled = true;
            }
        }

        function scanFile() {
            const f = document.getElementById('scan-file').files[0];
            if(!f) return;
            const reader = new Html5Qrcode("reader");
            if(html5Scanner) html5Scanner.clear(); // Clear live scanner first
            
            reader.scanFile(f, true)
                .then(onScanSuccess)
                .catch(e => alert("No QR found"));
        }

        function copyResult() { navigator.clipboard.writeText(scannedData); }
        function openLink() { window.open(scannedData, '_blank'); }

        function editScanned() {
            // Simple heuristics to pre-fill generator
            const txt = scannedData;
            let type = 'text', vals = {};

            if(txt.startsWith('WIFI:')) {
                type = 'wifi';
                const s = txt.match(/S:(.*?);/); vals['ssid'] = s ? s[1] : '';
                const p = txt.match(/P:(.*?);/); vals['pass'] = p ? p[1] : '';
            } else if(txt.startsWith('upi://')) {
                type = 'upi';
                const url = new URL(txt);
                vals['pa'] = url.searchParams.get('pa');
                vals['pn'] = url.searchParams.get('pn');
            } else if(txt.startsWith('mailto:')) {
                type = 'email';
                vals['mailto'] = txt.split(':')[1].split('?')[0];
            } else {
                vals['text'] = txt;
            }

            switchTab('creator');
            renderForm(type, vals);
        }

        // --- CREATOR LOGIC ---
        function renderTypeButtons() {
            const container = document.getElementById('type-list');
            container.innerHTML = '';
            for (const [key, conf] of Object.entries(formConfig)) {
                const btn = document.createElement('button');
                btn.className = `type-btn ${key === currentType ? 'active' : ''}`;
                btn.innerText = conf.label;
                btn.onclick = () => renderForm(key);
                container.appendChild(btn);
            }
        }

        function renderForm(type, values = {}) {
            currentType = type;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            Array.from(document.querySelectorAll('.type-btn')).find(b => b.innerText === formConfig[type].label)?.classList.add('active');

            const container = document.getElementById('dynamic-form');
            container.innerHTML = '';
            
            formConfig[type].fields.forEach(f => {
                const group = document.createElement('div');
                group.className = 'form-group';
                
                if (f.type === 'checkbox') {
                    const label = document.createElement('label');
                    label.style.display = 'flex'; label.style.alignItems = 'center'; label.style.gap = '0.5rem'; label.style.cursor = 'pointer';
                    const input = document.createElement('input');
                    input.type = 'checkbox'; input.id = f.id; input.onchange = updateQR;
                    if(values[f.id]) input.checked = true;
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(f.label));
                    group.appendChild(label);
                } else {
                    const label = document.createElement('label');
                    label.innerText = f.label;
                    group.appendChild(label);
                    
                    let input;
                    if (f.type === 'select') {
                        input = document.createElement('select');
                        for (const [val, txt] of Object.entries(f.opts)) {
                            const opt = document.createElement('option');
                            opt.value = val; opt.innerText = txt;
                            input.appendChild(opt);
                        }
                    } else if (f.type === 'textarea') {
                        input = document.createElement('textarea');
                        input.rows = f.rows || 3;
                    } else {
                        input = document.createElement('input');
                        input.type = f.type;
                        if(f.step) input.step = f.step;
                    }
                    input.id = f.id;
                    input.placeholder = f.placeholder || '';
                    if(values[f.id]) input.value = values[f.id];
                    input.oninput = updateQR;
                    group.appendChild(input);
                }
                container.appendChild(group);
            });
            updateQR();
        }

        function getVal(id) {
            const el = document.getElementById(id);
            return el ? (el.type === 'checkbox' ? el.checked : el.value) : '';
        }

        function updateQR() {
            let data = '';
            try {
                switch(currentType) {
                    case 'text': data = getVal('text'); break;
                    case 'wifi': 
                        const enc = getVal('enc');
                        data = `WIFI:S:${getVal('ssid')};T:${enc};P:${getVal('pass')};${getVal('hidden')?'H:true;':''};`;
                        break;
                    case 'upi':
                        const upi = `upi://pay?pa=${getVal('pa')}&pn=${encodeURIComponent(getVal('pn'))}`;
                        data = upi + (getVal('am') ? `&am=${getVal('am')}` : '') + (getVal('tn') ? `&tn=${encodeURIComponent(getVal('tn'))}` : '');
                        break;
                    case 'whatsapp': data = `https://wa.me/${getVal('wa_num')}?text=${encodeURIComponent(getVal('wa_msg'))}`; break;
                    case 'vcard':
                        data = `BEGIN:VCARD\nVERSION:3.0\nN:${getVal('ln')};${getVal('fn')}\nFN:${getVal('fn')} ${getVal('ln')}\nORG:${getVal('org')}\nTEL;TYPE=CELL:${getVal('tel')}\nEMAIL:${getVal('email')}\nEND:VCARD`;
                        break;
                    case 'email': data = `mailto:${getVal('mailto')}?subject=${encodeURIComponent(getVal('sub'))}&body=${encodeURIComponent(getVal('body'))}`; break;
                    case 'sms': data = `SMSTO:${getVal('sms_tel')}:${getVal('sms_body')}`; break;
                    case 'geo': data = `geo:${getVal('lat')},${getVal('lon')}`; break;
                    case 'event': 
                        const formatDt = (d) => d ? d.replace(/[-:]/g,'').split('.')[0]+'00' : '';
                        data = `BEGIN:VEVENT\nSUMMARY:${getVal('ev_sum')}\nLOCATION:${getVal('ev_loc')}\nDTSTART:${formatDt(getVal('ev_start'))}\nDTEND:${formatDt(getVal('ev_end'))}\nEND:VEVENT`;
                        break;
                }
            } catch(e) {}

            const dotsStyle = document.getElementById('dots-style').value;
            const cornersStyle = document.getElementById('corners-style').value;
            const fgColor = document.getElementById('fg-color').value;
            const bgColor = document.getElementById('bg-color').value;

            qrCode.update({
                data: data || ' ',
                dotsOptions: { color: fgColor, type: dotsStyle },
                cornersSquareOptions: { type: cornersStyle, color: fgColor },
                cornersDotOptions: { type: cornersStyle, color: fgColor },
                backgroundOptions: { color: bgColor },
                image: currentLogo
            });
        }

        function handleLogoUpload() {
            const file = document.getElementById('logo-file').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentLogo = e.target.result;
                    updateQR();
                };
                reader.readAsDataURL(file);
            }
        }

        function clearLogo() {
            currentLogo = null;
            document.getElementById('logo-file').value = "";
            updateQR();
        }

        async function downloadQR() {
            const ext = document.getElementById('dl-ext').value;
            const size = parseInt(document.getElementById('dl-size').value);
            
            // Temporary High Res Update for download
            qrCode.update({ width: size, height: size });
            await qrCode.download({ name: "qr-code", extension: ext });
            
            // Reset for preview
            qrCode.update({ width: 300, height: 300 });
        }
    </script>
</body>
</html>

